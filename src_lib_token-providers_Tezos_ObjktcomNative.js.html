<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/lib/token-providers/Tezos/ObjktcomNative.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: src/lib/token-providers/Tezos/ObjktcomNative.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import GraphQLProvider from "../../../class/GraphQLProvider";

/**
 * Native indexer for objkt.com.
 * @implements TokenProvider
 * @memberof Tezos
 */
class ObjktcomNative extends GraphQLProvider {
    /**
     * @param {String} key Unique TokenProvider instance identifier.
     * @param {Object} multiProviderOptions See {@link multiProviderOptions}.
     */
    constructor(key, options = {}) {
        super(key, ["*"], "https://data.objkt.com/v2/graphql");

        this.providerOptions = options;
    }

    platformName = "objkt.com";
    platformUrl = "https://objkt.com";

    async fetchTokens(tokenQuery) {
        const variables = {
            limit: tokenQuery.limit,
        };

        if (tokenQuery.orderBy.date) {
            variables.orderBy = [{ timestamp: tokenQuery.orderBy.date === "DESC" ? "desc" : "asc" }];
        }

        const whereClause = this.parseGraphQLWhereClause(tokenQuery);

        if (whereClause) {
            variables.where = whereClause;
        }

        variables.where = variables.where || {};
        variables.where._and = variables.where._and || [];
        variables.where._and.push({
            timestamp: {
                _is_null: false,
            },
        });

        const query = `query Token($where: token_bool_exp, $limit: Int, $orderBy: [token_order_by!]) {
                            token(where: $where, limit: $limit, order_by: $orderBy) {
                                pk
                                description
                                display_uri
                                token_id
                                timestamp
                                artifact_uri
                                name
                                mime
                                fa {
                                    collection_id
                                    contract
                                    creator {
                                        address
                                        alias
                                        tzdomain
                                    }
                                    description
                                    editions
                                    name
                                }
                                creators {
                                    holder {
                                        address
                                        alias
                                    }
                                }
                            }
                        }`;

        const fetchResponse = await this.queryGraphQL(query, variables);

        return fetchResponse.token.map((tokenMetadata) => this.parseTokenMetadata(tokenMetadata, tokenQuery));
    }

    // @TODO split parsing logic out by target object vs tokenQuery parameter.
    parseGraphQLWhereClause(tokenQuery) {
        const { after, before, tidSet, issuer, mimeTypeSet, owner } = tokenQuery;

        const whereClause = {};

        if (before || after) {
            if (before &amp;&amp; after) {
                whereClause.timestamp = {
                    _lt: before,
                    _gt: after,
                };
            } else if (before) {
                whereClause.timestamp = {
                    _lt: before,
                };
            } else if (after) {
                whereClause.timestamp = {
                    _gt: after,
                };
            }
        }

        if (owner) {
            whereClause.holders = {
                holder_address: {
                    _eq: owner,
                },
            };
        }

        if (issuer) {
            whereClause.fa = {
                creator_address: {
                    _eq: issuer,
                },
            };
        }

        const { contract: { allow: contractAllowSet, deny: contractDenySet } = {} } = this.providerOptions;

        if (contractAllowSet) {
            whereClause.fa_contract = {
                _in: contractAllowSet,
            };
        } else if (contractDenySet) {
            whereClause.fa_contract = {
                _nin: contractDenySet,
            };
        }

        if (tidSet) {
            const tidQueryPartialSet = tidSet.reduce((acc, tid) => {
                const delimiterIndex = tid.indexOf(":");
                const contract = tid.substring(0, delimiterIndex);
                const tokenId = tid.substring(delimiterIndex + 1);
                const contractAllowed = !contractAllowSet || contractAllowSet.includes(contract);
                const contractDenied = contractDenySet &amp;&amp; contractDenySet.includes(contract);

                if (contractAllowed &amp;&amp; !contractDenied) {
                    acc.push({
                        fa2_contract: { _eq: contract },
                        token_id: { _eq: tokenId },
                    });
                }

                return acc;
            }, []);

            if (tidQueryPartialSet.length) {
                whereClause._and = whereClause._and || [];

                whereClause._and.push({ _or: tidQueryPartialSet });
            }
        }

        if (mimeTypeSet) {
            whereClause.mime = {
                _in: mimeTypeSet,
            };
        }

        return Object.keys(whereClause) ? whereClause : null;
    }

    parseTokenMetadata(token) {
        const {
            artifact_uri: ipfsArtifact,
            creators,
            description,
            display_uri: ipfsDisplay,
            fa: { contract: contractAddress, creator: issuerMetadata },
            mime: mimeType,
            name,
            pk: tokenId,
            timestamp: createdAt,
        } = token;

        return {
            contract: {
                address: contractAddress,
                tokenId,
            },
            createdAt,
            description,
            ipfs: {
                artifact: ipfsArtifact,
                display: ipfsDisplay,
            },
            issuer: {
                address: (issuerMetadata &amp;&amp; issuerMetadata.address) || creators[0].creator_address,
            },
            mimeType,
            name,
            // @TODO flesh this out w/ contract > platform metadata w/ objkt.com fallback
            platform: {
                name: null,
                url: null,
                issuer: {
                    handle: null,
                    url: null,
                },
            },
            tid: `${contractAddress}:${tokenId}`,
            _metadata: {
                providerKey: this.key,
            },
        };
    }
}

export default ObjktcomNative;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-TokenFetchJS.html">TokenFetchJS</a></li></ul><h3>Namespaces</h3><ul><li><a href="Tezos.html">Tezos</a></li></ul><h3>Classes</h3><ul><li><a href="Tezos.ObjktcomNative.html">ObjktcomNative</a></li><li><a href="TokenFetch.html">TokenFetch</a></li></ul><h3>Interfaces</h3><ul><li><a href="TokenProvider.html">TokenProvider</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.11</a> on Wed Aug 31 2022 16:11:47 GMT-0700 (Pacific Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
